<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Memory game</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <div class="container">
        <div id="board"></div>
        <div id="play-status">
            <div id="player">
                <div id="player-name">プレイヤ－1</div>
            </div>
            <div id="player">
                <div id="player-name2">プレイヤ－2</div>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    const BOARD = document.getElementById('board')
    const TRUMP_BACK = document.getElementById('trump-back')
    const CARD = document.getElementById('card')
    const TRUMP_NUM = 13
    const TRUMP_MARK = 4
    const TRUMP_KEY_MIN = 0
    const TRUMP_KEY_MAX = 51

    const trumpNums = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K']
    const trumpMarks = ['♠', '♥', '♦', '♣']
    const trumpArray = new Array();

    let trumpKeys = []
    let turnCount = 0
    let firstChoice = ''
    let secondChoice = ''

    const genId = (x, y) => `${x}_${y}`
    const getCard = (cardNumber) =>
        document.getElementById(genId(cardNumber.x, cardNumber.y))

    function intRandom(max, min) {
        return Math.floor( Math.random() * (max - min + 1)) + min;
    }

    function singleRandomNum() {
        let keyNums = []
        let randomNums = []
        for (let i = 0; i <= TRUMP_KEY_MAX; i++) {
            keyNums[i] = i
        } 
        for (let j = 0; keyNums.length > 0; j++) {
            randomNum = intRandom(keyNums.length - 1, 0)
            trumpKeys = trumpKeys.concat(keyNums.splice(randomNum, 1))
        }
    }

    function createTrump() {
        for (let n = 0; n < trumpNums.length; n++) {
            for (let m = 0; m < trumpMarks.length; m++) {
                trumpArray.push([trumpNums[n], trumpMarks[m]])
            }
        }
    }

    function setInitTrump(cardNumber, trumpKey) {
        const card = getCard(cardNumber)
        setTrumpNum(card, trumpKey)
        setTrumpMark(card, trumpKey)
        setInitBackTrump(card)
    }

    function setTrumpNum(card, trumpKey) {
        const trumpNum = document.createElement('div')
        trumpNum.id = 'trump-num'
        card.appendChild(trumpNum)
        trumpNum.innerHTML = trumpArray[trumpKey][0]
        trumpNum.hidden = true  
    }

    function setTrumpMark(card, trumpKey) {
        const trumpMark = document.createElement('div')
        trumpMark.id = 'trump-mark'
        card.appendChild(trumpMark)
        trumpMark.innerHTML = trumpArray[trumpKey][1]
        trumpMark.hidden = true  
    }

    function setInitBackTrump(card) {
        const trumpBack = document.createElement('div')
        trumpBack.id = 'trump-back'
        card.appendChild(trumpBack)
    }

    function createBoard() {
        singleRandomNum()
        let count = 0
        for (let x = 0; x < 4; x++) {
            for (let y = 0; y < 13; y++) {
                const card = document.createElement('div')
                card.id = genId(x, y)
                card.classList.add('card')
                BOARD.appendChild(card)

                setInitTrump({x: x, y: y}, trumpKeys[count])
                ++count
            }
        }
    }

	function setFrontTrump(card){
        const trumpNum = card.children[0]
        const trumpMark = card.children[1]
        const trumpBack = card.children[2]
        trumpNum.hidden = false
        trumpMark.hidden = false
        trumpBack.hidden = true

        return card
	}

    function removeCard(card) {
        const trumpNum = card.children[0]
        const trumpMark = card.children[1]
        const trumpBack = card.children[2]
        trumpNum.hidden = true
        trumpMark.hidden = true
        trumpBack.hidden = true
        card.classList = 'remove-card'
        card.removeEventListener('click', trumpClick, false)
    }

    function setBackTrump(card) {
        const trumpNum = card.children[0]
        const trumpMark = card.children[1]
        const trumpBack = card.children[2]
        trumpNum.hidden = true
        trumpMark.hidden = true
        trumpBack.hidden = false
    }

    function isPairCheck(firstChoice, secondChoice) {
        const first = firstChoice.children[0].textContent
        const second = secondChoice.children[0].textContent
        if(first == second) {
            removeCard(firstChoice)
            removeCard(secondChoice)
        } else {
            setBackTrump(firstChoice)
            setBackTrump(secondChoice)
        }
    }

    function trumpClick() { 
        const card = event.currentTarget      
        ++turnCount
        if(turnCount == 1) {
            firstChoice = setFrontTrump(card)
        } else {
            secondChoice = setFrontTrump(card)
            setTimeout('isPairCheck(firstChoice, secondChoice)', 1700)
            turnCount = 0
        }
    }

    function addClick() {
        const cards = document.getElementsByClassName('card');
        for(let i = 0; i < cards.length; i++) {
            cards[i].addEventListener('click', trumpClick, false);
        }
    }

    createTrump()
    createBoard()
    addClick()

</script>

</html>