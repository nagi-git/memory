<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Memory game</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <div class="container">
        <div id="board"></div>
        <div class="play-status">
            <div id="current-player"></div>
            <div id="player1" class="player">
                <div class="player-name">プレイヤ－1</div>
                <div class="all-pair-trump"></div>
            </div>
            <div id="player2" class="player">
                <div class="player-name">プレイヤ－2</div>
                <div class="all-pair-trump"></div>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    const BOARD_HEIGHT = 4
    const BOARD_WIDTH = 13
    const TRUMP_COUNT = 52
    const PLAYER_COUNT = 2

    const BOARD = document.getElementById('board')
    const TRUMP = document.getElementsByClassName('.trump')

    const TRUMP_NUMS = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K']
    const TRUMP_MARKS = ['♠', '♥', '♦', '♣']

    let firstChoice = ''
    let secondChoice = ''
    let currentPlayerNum
    let firstPlayerNum = 1
    let choices = []

    function intRandom(max, min) {
        return Math.floor( Math.random() * (max - min + 1)) + min
    }

    function shuffleNumMarks(numMarks) {
        return numMarks
        // let keyNums = []
        // let randomNums = []
        // let trumpKeys = []
        // for (let i = 0; i < TRUMP_COUNT; i++) {
        //     keyNums[i] = i
        // }
        // for (let i = 0; keyNums.length > 0; i++) {
        //     randomNum = intRandom(keyNums.length - 1, 0)
        //     trumpKeys = trumpKeys.concat(keyNums.splice(randomNum, 1))
        // }
        
        // return trumpKeys
    }

    function createTrump() {
        const numMarks =
            TRUMP_NUMS.flatMap(trumpNum =>
                TRUMP_MARKS.map(trumpMark => ({num: trumpNum, mark: trumpMark})))

        const shuffledNumMarks = shuffleNumMarks(numMarks)
        shuffledNumMarks.forEach((numMark, trumpId) => {
            const trump = document.createElement('div')
            trump.id = trumpId
            trump.classList.add('trump')
            BOARD.appendChild(trump)
            setInitTrump(trump, numMark)
        })
    }

    function setInitTrump(trump, numMark) {
        setFrontFace(trump, numMark, true)
        setBackFace(trump, false)
    }

    function setPlayer(playerNum = currentPlayerNum % PLAYER_COUNT + 1) {
        currentPlayerNum = playerNum
        document.getElementById('current-player').innerHTML = currentPlayerNum
    }

    function setFrontFace(trump, numMark, hidden) {
        const trumpFront = document.createElement('div')
        trumpFront.classList = 'trump-front'
        trumpFront.hidden = hidden
        trump.appendChild(trumpFront)

        Object.entries(numMark).forEach(([k, v]) => {
            const div = document.createElement('div')
            div.classList = `trump-${k}`
            div.innerHTML = v
            trumpFront.appendChild(div)
        })
    }

    function setBackFace(trump, hidden) {
        const trumpBack = document.createElement('div')
        trumpBack.classList = 'trump-back'
        trumpBack.hidden = hidden
        trump.appendChild(trumpBack)
    }

    function turnTrump(trump) {
        Array.from(trump.children)
            .forEach(face => face.hidden = !face.hidden)
    }

    function removeTrump(trump) {
        Array.from(trump.children)
            .forEach(face => face.hidden = true)
        trump.classList = 'remove-trump'
        trump.removeEventListener('click', trumpClick, false) // これを消したい。
        // カードの状態によってイベントを付けたり消したりするのは、メンテナンス性が低下する。
        // trumpClick()内で、削除済みのカードなら何もしないようにした方がイケてます。
    }

    function addPairTrump(trump) {
        console.log(currentPlayerNum)
        const player = document.getElementById(`player${currentPlayerNum}`).children[1]
        const pairTrump = document.createElement('div')
        pairTrump.classList = 'pair-trump'
        player.appendChild(pairTrump)
        setFrontFace(pairTrump, {
            num: trump.children[0].children[0].textContent,
            mark: trump.children[0].children[1].textContent}, false)
    }

    function openEventHandler(firstChoice, secondChoice) {
        const first = firstChoice.children[0].textContent // 関数に分けよう！
        const second = secondChoice.children[0].textContent
        if(first == second) {
            addPairTrump(firstChoice)
            addPairTrump(secondChoice)
            removeTrump(firstChoice)
            removeTrump(secondChoice)
        } else {
            turnTrump(firstChoice)
            turnTrump(secondChoice)
            ++currentPlayerNum
            if(currentPlayerNum > PLAYER_COUNT) {
                currentPlayerNum = 1
            }
            setCurrentPlayer()
        }
    }

    function openEventHandler_ryo() {
        if (choices.length < 2) {
            return
        }

        disableClick()
        setTimeout(() => {
            const firstTrump = choices[0] // 関数に分けよう！
            const secondTrump = choices[1]
            if(firstTrump.children[0].children[0].textContent == secondTrump.children[0].children[0].textContent) {
                choices.forEach(choice => {
                    addPairTrump(choice)
                    removeTrump(choice)
                })
            } else {
                choices.forEach(turnTrump)
                setPlayer()
            }
            choices = []
            ableClick()
        }, 1000)
    }

    function trumpClick() { 
        const trump = event.currentTarget
        turnTrump(trump)
        choices.push(trump)
        openEventHandler_ryo()
    }

    function addClick() {
        const trumps = document.getElementsByClassName('trump')
        for(let i = 0; i < trumps.length; i++) {
            trumps[i].addEventListener('click', trumpClick, false)
        }
    }

    // 透明divで代替するのが良さそう
    function disableClick() {
        const trumps = document.getElementsByClassName('trump')
        for(let i = 0; i < trumps.length; i++) {
            trumps[i].style.pointerEvents = 'none'
        }
    }

    function ableClick() {
        const trumps = document.getElementsByClassName('trump')
        for(let i = 0; i < trumps.length; i++) {
            trumps[i].style.pointerEvents = 'auto'
        }
    }


    createTrump()
    setPlayer(firstPlayerNum)
    addClick()

</script>

</html>