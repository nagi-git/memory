<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Memory game</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <div class="container">
        <div id="board"></div>
        <div class="play-status">
            <div class="current-player"></div>
            <div id="player1" class="player">
                <div class="player-name">プレイヤ－1</div>
                <div class="all-pair-card"></div>
            </div>
            <div id="player2" class="player">
                <div class="player-name">プレイヤ－2</div>
                <div class="all-pair-card"></div>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    const TRUMP_NUM = 13
    const TRUMP_MARK = 4
    const TRUMP_KEY_MIN = 0
    const TRUMP_KEY_MAX = 51
    const PLAYER_COUNT = 2

    const BOARD = document.getElementById('board')
    const CARD = document.querySelectorAll('.card')

    const trumpNums = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K']
    const trumpMarks = ['♠', '♥', '♦', '♣']
    const trumpArray = new Array();

    let trumpKeys = []
    let turnCount = 0
    let firstChoice = ''
    let secondChoice = ''
    let currentPlayerNum = 1

    const genId = (x, y) => `${x}_${y}`
    const getCard = (cardNumber) =>
        document.getElementById(genId(cardNumber.x, cardNumber.y))

    function intRandom(max, min) {
        return Math.floor( Math.random() * (max - min + 1)) + min;
    }

    function singleRandomNum() {
        let keyNums = []
        let randomNums = []
        for (let i = 0; i <= TRUMP_KEY_MAX; i++) {
            keyNums[i] = i
        } 
        for (let j = 0; keyNums.length > 0; j++) {
            randomNum = intRandom(keyNums.length - 1, 0)
            trumpKeys = trumpKeys.concat(keyNums.splice(randomNum, 1))
        }
    }

    function createTrump() {
        for (let n = 0; n < trumpNums.length; n++) {
            for (let m = 0; m < trumpMarks.length; m++) {
                trumpArray.push([trumpNums[n], trumpMarks[m]])
            }
        }
    }

    function createBoard() {
        singleRandomNum()
        let count = 0
        for (let x = 0; x < 4; x++) {
            for (let y = 0; y < 13; y++) {
                const card = document.createElement('div')
                card.id = genId(x, y)
                card.classList.add('card')
                BOARD.appendChild(card)
                setInitTrump({x: x, y: y}, trumpArray[trumpKeys[count]])
                ++count
            }
        }
    }

    function setInitTrump(cardNumber, trumpContent) {
        const card = getCard(cardNumber)
        setTrumpNum(card, trumpContent[0])
        setTrumpMark(card, trumpContent[1])
        createBackTrump(card)
        setBackTrump(card)
    }

    function setCurrentPlayer() {
        const currentPlayer = document.querySelectorAll('.current-player')
        console.log(currentPlayer)
        currentPlayer.innerHTML = currentPlayerNum
    }

    function setTrumpNum(card, trumpContent) {
        const trumpNum = document.createElement('div')
        trumpNum.classList = 'trump-num'
        card.appendChild(trumpNum)
        trumpNum.innerHTML = trumpContent
    }

    function setTrumpMark(card, trumpContent) {
        const trumpMark = document.createElement('div')
        trumpMark.classList = 'trump-mark'
        card.appendChild(trumpMark)
        trumpMark.innerHTML = trumpContent
    }

    function createBackTrump(card) {
        const trumpBack = document.createElement('div')
        trumpBack.classList = 'trump-back'
        card.appendChild(trumpBack)
    }

	function setFrontTrump(card){
        const trumpNum = card.children[0]
        const trumpMark = card.children[1]
        const trumpBack = card.children[2]
        trumpNum.hidden = false
        trumpMark.hidden = false
        trumpBack.hidden = true

        return card
	}

    function setBackTrump(card) {
        const trumpNum = card.children[0]
        const trumpMark = card.children[1]
        const trumpBack = card.children[2]
        trumpNum.hidden = true
        trumpMark.hidden = true
        trumpBack.hidden = false
    }

    function removeCard(card) {
        const trumpNum = card.children[0]
        const trumpMark = card.children[1]
        const trumpBack = card.children[2]
        trumpNum.hidden = true
        trumpMark.hidden = true
        trumpBack.hidden = true
        card.classList = 'remove-card'
        card.removeEventListener('click', trumpClick, false)
    }

    function addPairCard(card) {
        const player = document.getElementById(`player${currentPlayerNum}`).children[1]
        const pairCard = document.createElement('div')
        pairCard.classList = 'pair-card'
        player.appendChild(pairCard)
        setTrumpNum(pairCard, card.children[0].textContent)
        setTrumpMark(pairCard, card.children[1].textContent)
    }

    function openEventHandler(firstChoice, secondChoice) {
        ableClick()
        const first = firstChoice.children[0].textContent
        const second = secondChoice.children[0].textContent
        if(first == second) {
            addPairCard(firstChoice)
            addPairCard(secondChoice)
            removeCard(firstChoice)
            removeCard(secondChoice)
        } else {
            setBackTrump(firstChoice)
            setBackTrump(secondChoice)
            ++currentPlayerNum
        }
    }

    function trumpClick() { 
        const card = event.currentTarget
        ++turnCount
        if(currentPlayerNum > PLAYER_COUNT) {
            currentPlayerNum = 1
        }
        if(turnCount == 1) {
            firstChoice = setFrontTrump(card)
        } else {
            secondChoice = setFrontTrump(card)
            disableClick()
            setTimeout('openEventHandler(firstChoice, secondChoice)', 1000)
            turnCount = 0
        }
    }

    function addClick() {
        const cards = document.getElementsByClassName('card')
        for(let i = 0; i < cards.length; i++) {
            cards[i].addEventListener('click', trumpClick, false)
        }
    }

    function disableClick() {
        const cards = document.getElementsByClassName('card')
        for(let i = 0; i < cards.length; i++) {
            cards[i].style.pointerEvents = 'none'
        }
    }

    function ableClick() {
        const cards = document.getElementsByClassName('card')
        for(let i = 0; i < cards.length; i++) {
            cards[i].style.pointerEvents = 'auto'
        }
    }


    createTrump()
    createBoard()
    setCurrentPlayer()
    addClick()

</script>

</html>